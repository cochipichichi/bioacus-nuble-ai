import{AudioMod}from'./audio.js';import{ML}from'./ml.js';import{barChart}from'./chart.js';const $=e=>document.querySelector(e);let spectCtx=null,spectDPI=1;function setTheme(e){document.documentElement.classList.remove('theme-light','theme-contrast','theme-sepia'),'light'===e&&document.documentElement.classList.add('theme-light'),'contrast'===e&&document.documentElement.classList.add('theme-contrast'),'sepia'===e&&document.documentElement.classList.add('theme-sepia'),localStorage.setItem('theme',e),document.querySelector('meta[name="theme-color"]').setAttribute('content',getComputedStyle(document.documentElement).getPropertyValue('--bg').trim()),$('#themeLabel').textContent='light'===e?'‚òÄÔ∏è Claro':'contrast'===e?'‚ö° Alto contraste':'sepia'===e?'üìú Sepia':'üåô Oscuro'}window.setTheme=setTheme;function initSpectrogram(){const e=$('#spect');spectCtx=e.getContext('2d'),spectDPI=window.devicePixelRatio||1;const t=e.clientWidth*spectDPI,o=e.clientHeight*spectDPI;e.width=t,e.height=o,spectCtx.fillStyle='rgba(0,0,0,0)',spectCtx.fillRect(0,0,t,o)}function drawSpectrum(e){const t=$('#spect'),o=spectCtx,n=t.width,a=t.height,r=o.getImageData(1,0,n-1,a);o.putImageData(r,0,0);const c=o.createImageData(1,a);for(let t=0;t<a;t++){const o=1-t/a,r=Math.floor(o*(e.length-1)),n=(e[r]+140)/140,s=Math.max(0,Math.min(255,Math.floor(255*n))),l=4*t;c.data[l+0]=20,c.data[l+1]=s,c.data[l+2]=255,c.data[l+3]=Math.floor(80+175*n)}o.putImageData(c,n-1,0)}function updateBars(e,t){barChart($('#bars'),t,e.map((e=>+(100*e).toFixed(1))))}function toJSONDownload(e,t){const o=new Blob([t],{type:'application/json'}),n=URL.createObjectURL(o),a=document.createElement('a');a.href=n,a.download=e,a.click(),URL.revokeObjectURL(n)}function initThemeMenu(){const e=$('#themeMenu');$('#themeBtn').addEventListener('click',(()=>e.classList.toggle('open'))),document.addEventListener('click',(t=>{e.contains(t.target)||t.target!==$('#themeBtn')||e.classList.remove('open')})),document.addEventListener('keydown',(t=>{'Escape'===t.key&&e.classList.remove('open')}))}async function init(){initSpectrogram();const e=localStorage.getItem('theme')||'dark';setTheme(e),initThemeMenu(),$('#btn-start').addEventListener('click',async()=>{await AudioMod.start(),AudioMod.mod.onFrame=({freq:e,sampleRate:t,fftSize:o})=>{drawSpectrum(e);const n=AudioMod.bands16(e,t,o),a=ML.predict(n);updateBars(a.probs,a.labels),$('#now-predict').textContent=a.labels[a.probs.indexOf(Math.max(...a.probs))]||'‚Äî'},$('#rec-state').textContent='Grabando‚Ä¶'}),$('#btn-stop').addEventListener('click',()=>{AudioMod.stop(),$('#rec-state').textContent='Detenido'}),$('#btn-capture').addEventListener('click',()=>{if(!AudioMod.mod.analyser)return void alert('Inicia la grabaci√≥n');const e=new Float32Array(AudioMod.mod.analyser.frequencyBinCount);AudioMod.mod.analyser.getFloatFrequencyData(e);const t=AudioMod.bands16(e,AudioMod.mod.sampleRate,AudioMod.mod.fftSize),o=($('#label').value||'').trim()||'Desconocido';ML.addSample(o,t),$('#status').textContent=`A√±adida huella a ${o}`}),$('#btn-train').addEventListener('click',()=>{const e=ML.computeCentroids();$('#status').textContent=`Centroides: ${Object.keys(e).join(', ')||'‚Äî'}`}),$('#btn-export').addEventListener('click',()=>{toJSONDownload('bioacus-fingerprints.json',ML.exportJSON())}),$('#file-import').addEventListener('change',async e=>{const t=e.target.files[0];if(!t)return;const o=await t.text();ML.importJSON(o),$('#status').textContent='Dataset importado ‚úÖ'}),$('#file-audio').addEventListener('change',async e=>{const t=e.target.files[0];if(!t)return;const o=new(window.AudioContext||window.webkitAudioContext),n=await t.arrayBuffer(),a=await o.decodeAudioData(n),r=a.getChannelData(0);let c=0;for(let e=0;e<Math.min(r.length,o.sampleRate);e++)c+=r[e]*r[e];c=Math.sqrt(c/o.sampleRate),$('#status').textContent='Audio cargado. RMS ~ '+c.toFixed(3)}),$('#label').value=ML.state.labels[0]||'Chucao'}window.addEventListener('DOMContentLoaded',init);